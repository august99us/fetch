name: macOS GUI Basic (Apple Silicon)

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  build-gui-basic:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Protoc
      uses: arduino/setup-protoc@v3

    - name: Install Rust target for Apple Silicon
      run: rustup target add aarch64-apple-darwin

    - name: Download ONNX Runtime (CPU - ARM64)
      run: |
        echo "Fetching latest ONNX Runtime version..."
        VERSION=$(curl -s https://api.github.com/repos/microsoft/onnxruntime/releases/latest | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/')
        echo "Latest version: $VERSION"

        URL="https://github.com/microsoft/onnxruntime/releases/download/v${VERSION}/onnxruntime-osx-arm64-${VERSION}.tgz"
        echo "Downloading ONNX Runtime from $URL"
        curl -L -o onnxruntime.tgz "$URL"

        echo "Extracting ONNX Runtime..."
        tar -xzf onnxruntime.tgz
        EXTRACTED_DIR=$(ls -d onnxruntime-osx-* | head -1)

        if [ -z "$EXTRACTED_DIR" ]; then
          echo "Error: No directory found in extracted archive"
          exit 1
        fi

        echo "Extracted to: $EXTRACTED_DIR"
        LIB_PATH="$PWD/$EXTRACTED_DIR/lib"
        echo "ONNX_BUILD_PATH will be: $LIB_PATH"
        echo "ONNX_BUILD_PATH=$LIB_PATH" >> $GITHUB_ENV

    - name: Download models from Hugging Face
      run: |
        echo "Downloading models from Hugging Face..."

        MODELS_DIR="fetch-core/bundle/models"
        mkdir -p "$MODELS_DIR"

        # Function to download a Hugging Face model
        download_hf_model() {
            local model_name="$1"
            local repo_id="$2"
            local output_dir="$3"

            local model_path="$output_dir/$model_name"

            if [ -d "$model_path" ]; then
                echo "$model_name already exists, skipping download"
                return
            fi

            echo "Fetching model info for $repo_id..."
            local api_url="https://huggingface.co/api/models/$repo_id"
            local model_info=$(curl -s "$api_url")

            mkdir -p "$model_path"

            # Parse the JSON response and download each file
            echo "$model_info" | jq -r '.siblings[].rfilename' | while read -r filename; do
                if [ -z "$filename" ]; then
                    continue
                fi

                local file_url="https://huggingface.co/$repo_id/resolve/main/$filename"
                local dest_path="$model_path/$filename"

                # Create parent directories if needed
                local parent_dir=$(dirname "$dest_path")
                mkdir -p "$parent_dir"

                echo "Downloading $filename..."
                curl -L -o "$dest_path" "$file_url"
            done

            echo "Completed download of $model_name"
        }

        # Download both models
        download_hf_model "siglip2-base-patch16-512" "august99us/siglip2-base-patch16-512-fetch" "$MODELS_DIR"
        download_hf_model "embeddinggemma-300m" "august99us/embeddinggemma-300m-fetch" "$MODELS_DIR"

        echo "All models downloaded successfully"

    - name: install frontend dependencies
      working-directory: fetch-tauri
      run: npm install

    - name: Build Tauri application (Basic - Apple Silicon)
      working-directory: fetch-tauri
      run: npm run tauri build -- --target aarch64-apple-darwin

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fetch-macos-basic-arm64
        path: |
          target/aarch64-apple-darwin/release/bundle/
        retention-days: 7